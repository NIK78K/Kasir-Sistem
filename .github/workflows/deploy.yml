name: Deploy to Biznet VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        env:
          COMPOSER_PROCESS_TIMEOUT: 0
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment archive
        run: |
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='bootstrap/cache/*' \
            --exclude='.gitignore' \
            --exclude='.editorconfig' \
            --exclude='phpunit.xml' \
            --exclude='README.md' \
            --warning=no-file-changed \
            . || [ $? -eq 1 ]
          
          ls -lh deployment.tar.gz

      - name: Upload to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deployment.tar.gz"
          target: "/tmp/"
          timeout: 10m

      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 15m
          script: |
            #!/bin/bash
            set -e
            
            PROJECT_PATH="/var/www/Kasir-Sistem"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/kasir-sistem"
            
            echo "=================================================="
            echo "Starting Deployment - $TIMESTAMP"
            echo "=================================================="
            
            # Check deployment file
            if [ ! -f "/tmp/deployment.tar.gz" ]; then
              echo "ERROR: deployment.tar.gz not found!"
              exit 1
            fi
            
            cd $PROJECT_PATH
            
            # Create backup
            echo "Creating backup..."
            mkdir -p $BACKUP_DIR
            tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude='node_modules' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              . 2>/dev/null || true
            
            # Keep last 5 backups
            cd $BACKUP_DIR
            ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
            cd $PROJECT_PATH
            
            echo "Backup created successfully"
            
            # Backup .env
            cp .env .env.backup 2>/dev/null || true
            
            # Clean old files (kecuali storage dan .env)
            echo "Cleaning old files..."
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'storage' \
              ! -name '.env' \
              ! -name '.env.backup' \
              -exec rm -rf {} + 2>/dev/null || true
            
            # Extract new files (skip storage folders yang sudah ada)
            echo "Extracting new files..."
            tar -xzf /tmp/deployment.tar.gz \
              --exclude='storage/framework/cache' \
              --exclude='storage/framework/sessions' \
              --exclude='storage/framework/views' \
              --exclude='storage/framework/testing' \
              --exclude='storage/logs' \
              --exclude='storage/app/public' \
              -C . 2>/dev/null || true
            
            rm -f /tmp/deployment.tar.gz
            
            # Restore .env
            if [ ! -f .env ] && [ -f .env.backup ]; then
              mv .env.backup .env
            else
              rm -f .env.backup
            fi
            
            # Fix permissions SEBELUM run artisan
            echo "Setting permissions..."
            sudo chown -R $USER:www-data $PROJECT_PATH
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod 664 .env
            
            # Run artisan commands (sekarang user punya akses write)
            echo "Running migrations..."
            php artisan migrate --force
            
            echo "Optimizing..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Set ownership ke www-data setelah artisan selesai
            echo "Final permission setup..."
            sudo chown -R www-data:www-data $PROJECT_PATH
            sudo chmod -R 775 storage bootstrap/cache
            
            echo "=================================================="
            echo "Deployment completed successfully!"
            echo "Version: $TIMESTAMP"
            echo "=================================================="

      - name: Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment berhasil!"
          echo "üåê Aplikasi sudah live"
      
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment gagal!"
          echo "üîç Cek logs untuk detail"