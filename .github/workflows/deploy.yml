name: Deploy to Biznet VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        env:
          COMPOSER_PROCESS_TIMEOUT: 0
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment archive
        run: |
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='bootstrap/cache/*' \
            --exclude='.gitignore' \
            --exclude='.editorconfig' \
            --exclude='phpunit.xml' \
            --exclude='README.md' \
            --warning=no-file-changed \
            . || [ $? -eq 1 ]
          
          ls -lh deployment.tar.gz

      - name: Upload to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deployment.tar.gz"
          target: "/tmp/"
          timeout: 10m

      - name: Deploy on VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 15m
          script: |
            #!/bin/bash
            set -e
            
            PROJECT_PATH="/var/www/Kasir-Sistem"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/kasir-sistem"
            
            echo "=================================================="
            echo "Starting Deployment - $TIMESTAMP"
            echo "=================================================="
            
            # Check deployment file
            if [ ! -f "/tmp/deployment.tar.gz" ]; then
              echo "ERROR: deployment.tar.gz not found!"
              exit 1
            fi
            
            cd $PROJECT_PATH
            
            # Create backup
            echo "Creating backup..."
            mkdir -p $BACKUP_DIR
            tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude='node_modules' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              . 2>/dev/null || true
            
            # Keep last 5 backups
            cd $BACKUP_DIR
            ls -t backup_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm -f
            cd $PROJECT_PATH
            
            echo "Backup created successfully"
            
            # Backup .env
            cp .env .env.backup 2>/dev/null || true
            
            # IMPORTANT: Change ownership ke user dulu sebelum delete
            echo "Changing ownership..."
            sudo chown -R $USER:$USER $PROJECT_PATH
            
            # Clean old files LEBIH AGRESIF (kecuali storage dan .env)
            echo "Cleaning old files..."
            rm -rf app/
            rm -rf bootstrap/
            rm -rf config/
            rm -rf database/
            rm -rf public/
            rm -rf resources/
            rm -rf routes/
            rm -rf vendor/
            rm -f *.php
            rm -f *.json
            rm -f *.js
            rm -f *.md
            
            # Extract new files dengan overwrite
            echo "Extracting new files..."
            tar -xzf /tmp/deployment.tar.gz --overwrite -C .
            
            rm -f /tmp/deployment.tar.gz
            
            # Restore .env
            if [ -f .env.backup ]; then
              mv .env.backup .env
            fi
            
            # Fix permissions SEBELUM run artisan
            echo "Setting permissions..."
            chmod -R 775 storage bootstrap/cache
            chmod 664 .env
            
            # Run artisan commands (sekarang user punya akses write)
            echo "Running migrations..."
            php artisan migrate --force
            
            echo "Clearing all caches AGGRESSIVELY..."
            php artisan cache:clear || true
            php artisan config:clear || true
            php artisan route:clear || true
            php artisan view:clear || true
            php artisan optimize:clear || true
            
            # Hapus cache files manually
            rm -rf storage/framework/cache/data/* || true
            rm -rf storage/framework/views/* || true
            rm -rf bootstrap/cache/*.php || true
            
            echo "Rebuilding caches..."
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize
            
            # Set ownership ke www-data SETELAH semua selesai
            echo "Final ownership setup..."
            sudo chown -R www-data:www-data $PROJECT_PATH
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod -R 755 $PROJECT_PATH
            sudo chmod 644 $PROJECT_PATH/.env
            
            # Restart PHP-FPM untuk clear opcache
            echo "Restarting PHP-FPM..."
            sudo systemctl restart php8.3-fpm || sudo systemctl restart php-fpm || true
            
            # Reload nginx
            echo "Reloading Nginx..."
            sudo systemctl reload nginx || true
            
            # Verify deployment
            echo "Verifying files..."
            ls -lh public/index.php
            head -5 routes/web.php
            
            # Set ownership ke www-data setelah artisan selesai
            echo "Final permission setup..."
            sudo chown -R www-data:www-data $PROJECT_PATH
            sudo chmod -R 775 storage bootstrap/cache
            
            echo "=================================================="
            echo "Deployment completed successfully!"
            echo "Version: $TIMESTAMP"
            echo "=================================================="

      - name: Deployment Success
        if: success()
        run: |
          echo "‚úÖ Deployment berhasil!"
          echo "üåê Aplikasi sudah live"
      
      - name: Deployment Failed
        if: failure()
        run: |
          echo "‚ùå Deployment gagal!"
          echo "üîç Cek logs untuk detail"