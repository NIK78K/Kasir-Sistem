name: Deploy to Biznet VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist
        env:
          COMPOSER_PROCESS_TIMEOUT: 0
          COMPOSER_NO_INTERACTION: 1
          COMPOSER_NO_AUDIT: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install NPM dependencies
        run: npm ci

      - name: Build assets
        run: npm run build

      - name: Create deployment archive
        run: |
          tar -czf deployment.tar.gz \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='tests' \
            --exclude='.env' \
            --exclude='.env.example' \
            --exclude='storage/logs/*' \
            --exclude='storage/framework/cache/*' \
            --exclude='storage/framework/sessions/*' \
            --exclude='storage/framework/views/*' \
            --exclude='bootstrap/cache/*' \
            --exclude='.gitignore' \
            --exclude='.editorconfig' \
            --exclude='phpunit.xml' \
            --exclude='README.md' \
            --warning=no-file-changed \
            .
          
          echo "ğŸ“¦ Archive created: $(ls -lh deployment.tar.gz | awk '{print $5}')"

      - name: Deploy to VPS
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deployment.tar.gz"
          target: "/tmp/"
          timeout: 10m

      - name: Execute deployment script
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          timeout: 15m
          script: |
            set -e
            
            PROJECT_PATH="/var/www/Kasir-Sistem"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            BACKUP_DIR="$HOME/backups/kasir-sistem"
            
            echo "=================================================="
            echo "ğŸš€ Starting Deployment - $TIMESTAMP"
            echo "=================================================="
            
            # Validasi file deployment
            if [ ! -f "/tmp/deployment.tar.gz" ]; then
              echo "âŒ Error: deployment.tar.gz tidak ditemukan!"
              exit 1
            fi
            
            cd $PROJECT_PATH
            
            # Backup
            echo "ğŸ“¦ Creating backup..."
            mkdir -p $BACKUP_DIR
            tar -czf "$BACKUP_DIR/backup_$TIMESTAMP.tar.gz" \
              --exclude='node_modules' \
              --exclude='storage/logs/*' \
              --exclude='storage/framework/cache/*' \
              --exclude='storage/framework/sessions/*' \
              --exclude='storage/framework/views/*' \
              . 2>/dev/null || echo "âš ï¸ Backup completed with warnings"
            
            # Keep only last 5 backups
            ls -t $BACKUP_DIR/backup_*.tar.gz | tail -n +6 | xargs -r rm
            echo "âœ… Backup created: backup_$TIMESTAMP.tar.gz"
            
            # Enable maintenance mode
            echo "ğŸ”§ Enabling maintenance mode..."
            php artisan down --retry=60 || echo "âš ï¸ App already in maintenance mode"
            
            # Backup .env
            echo "ğŸ’¾ Backing up .env..."
            cp .env .env.backup
            
            # Clean old files (except storage & .env)
            echo "ğŸ§¹ Cleaning old files..."
            find . -mindepth 1 -maxdepth 1 \
              ! -name 'storage' \
              ! -name '.env' \
              ! -name '.env.backup' \
              -exec rm -rf {} + 2>/dev/null || true
            
            # Extract new files
            echo "ğŸ“‚ Extracting new files..."
            tar -xzf /tmp/deployment.tar.gz -C .
            rm /tmp/deployment.tar.gz
            
            # Restore .env if not exists
            if [ ! -f .env ]; then
              echo "âš ï¸ Restoring .env from backup..."
              mv .env.backup .env
            else
              rm -f .env.backup
            fi
            
            # Set permissions
            echo "ğŸ” Setting permissions..."
            sudo chown -R www-data:www-data $PROJECT_PATH
            sudo chmod -R 775 storage bootstrap/cache
            sudo chmod 644 .env
            
            # Run migrations and optimizations
            echo "ğŸ—„ï¸ Running migrations..."
            php artisan migrate --force
            
            echo "âš¡ Optimizing application..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan event:cache
            
            # Restart services (optional - uncomment if needed)
            # echo "ğŸ”„ Restarting services..."
            # sudo systemctl restart php8.3-fpm
            # sudo systemctl reload nginx
            
            # Disable maintenance mode
            echo "âœ… Disabling maintenance mode..."
            php artisan up
            
            echo "=================================================="
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ“… Version: $TIMESTAMP"
            echo "ğŸ“¦ Backup: $BACKUP_DIR/backup_$TIMESTAMP.tar.gz"
            echo "=================================================="

      - name: Health check
        if: success()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /var/www/Kasir-Sistem
            
            echo "ğŸ¥ Running health checks..."
            
            # Check PHP version
            php -v | head -n 1
            
            # Check Laravel version
            php artisan --version
            
            # Check database connection
            php artisan migrate:status | head -n 5
            
            # Check disk space
            df -h | grep -E '^/dev/'
            
            echo "âœ… Health check completed!"

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment berhasil!"
            echo "ğŸŒ Aplikasi sudah live di production"
          else
            echo "âŒ Deployment gagal!"
            echo "ğŸ” Silakan cek logs untuk detail error"
            exit 1
          fi